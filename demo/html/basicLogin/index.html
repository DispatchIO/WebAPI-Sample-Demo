<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>用户登录 -- Dispatch WebSDK API</title>
    <link rel="stylesheet" href="./index.css" />
    <link rel="stylesheet" href="../assets/styles/index.css" />
    <link rel="stylesheet" href="../assets/js/element-plus/index.css" />
    <script src="../assets/js/flexible.js"></script>
    <script src="../assets/js/vue.global.js"></script>
    <script src="../assets/js/element-plus/index.js"></script>
    <script src="../assets/js/tailwindcss.js"></script>

    <!-- 导入axios依赖包-->
    <script src="../assets/js/axios.min.js"></script>
    <!-- cryptoJs 依赖包 -->
    <script src="../assets/js/crypto-js.js"></script>
    <!-- socket.io依赖 -->
    <script src="../assets/js/socket.io.js"></script>
    <!-- sdk-->
    <script src="../../../sdk/dispatch-sdk.js"></script>
    <!-- 配置文件-->
    <script src="../assets/index.js"></script>
  </head>

  <body>
    <div id="app">
      <div class="w-full h-full flex flex-col overflow-hidden">
        <div
          class="h-10 flex items-center px-4 text-white text-sm bg-[#52575c]"
        >
          用户登录
        </div>

        <div
          class="flex1 w-full pl-52 pr-52 pt-4 overflow-y-auto flex justify-center"
        >
          <el-form
            ref="formRef"
            :model="form"
            label-width="auto"
            :rules="rules"
            class="w-1/2"
          >
            <el-form-item prop="username" label="用户名">
              <el-input v-model="form.username" />
            </el-form-item>
            <el-form-item prop="password" label="密码">
              <el-input v-model="form.password" />
            </el-form-item>

            <el-form-item>
              <el-button :disabled="isLogin" @click="handleLogin"
                >登录</el-button
              >
              <el-button :disabled="!isLogin" @click="quitClient"
                >登出</el-button
              >
              <el-button :disabled="!isLogin" @click="handleDuty"
                >{{isStartWork ? '关闭无人值守' : '开启无人值守'}}</el-button
              >
              <el-button :disabled="!isLogin" @click="handleOperatorInfo"
                >查看个人信息</el-button
              >
            </el-form-item>

            <el-form-item v-if="showInfo" label="个人信息">
              <el-input v-model="operatorInfo" type="textarea" :rows="10" />
            </el-form-item>
          </el-form>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onBeforeMount } = Vue;

      createApp({
        setup() {
          const form = ref({});
          const formRef = ref(null);
          const rules = ref({
            username: [
              {
                required: true,
                message: "请输入用户名",
                trigger: "blur",
              },
            ],
            password: [
              {
                required: true,
                message: "请输入密码",
                trigger: "blur",
              },
            ],
          });
          const isLogin = ref(false);
          const isStartWork = ref(false);
          const showInfo = ref(false);
          const operatorInfo = ref({});

          /**
           * 登录操作
           */
          const handleLogin = () => {
            formRef.value.validate((valid, fields) => {
              if (valid) {
                // 登录
                DispRTC.client
                  .login(form.value.username, form.value.password)
                  .then((res) => {
                    console.log(res);
                    isLogin.value = true;
                  })
                  .catch((err) => {
                    isLogin.value = false;
                    ElementPlus.ElMessage({
                      type: "warning",
                      message: err.msg,
                      duration: 0,
                      showClose: true,
                    });
                  });
              }
            });
          };

          /**
           * 退出客户端
           */
          function quitClient() {
            localStorageNaNpxoveItem("DispRTC-token");
            DispRTC.destroy();
            isLogin.value = false;
          }

          // 点击开启、关闭值班事件
          function quitClient() {
            localStorageNaNpxoveItem("DispRTC-token");
            DispRTC.destroy();
            isLogin.value = false;
          }

          // 点击开启、关闭值班事件
          function handleDuty() {
            if (isStartWork.value) {
              DispRTC.client.stopWork();
            } else {
              DispRTC.client.startWork();
            }
            isStartWork.value = !isStartWork.value;
          }
          // 查看个人信息
          function handleOperatorInfo() {
            DispRTC.client.getOperatorInfo().then((res) => {
              console.log(res);
              showInfo.value = true;
              operatorInfo.value = JSON.stringify(res.data);
            });
          }

          //事件处理
          const handleEvent = ({ data, eventType }) => {
            console.log("handleEvent", eventType, data);
            if (eventType === "LoginStatus") {
              ElementPlus.ElMessage.closeAll();
              ElementPlus.ElMessage({
                type: "warning",
                message: data.msg,
              });
              if ([403, 480].includes(data.code)) {
                isLogin.value = false;
                //清除本地缓存
                localStorageNaNpxoveItem("DispRTC-token");
              }
            }
          };

          // 订阅事件
          const subscribeEvent = () => {
            //可以针对特定的事件，也可以针对所有事件，这里订阅所有事件
            DispRTC.client.on("All", handleEvent);
          };

          onBeforeMount(() => {
            subscribeEvent();
            // 判断是否已经登录
            if (DispRTC.client._isLogin()) {
              isLogin.value = true;
              ElementPlus.ElMessage({
                type: "warning",
                message: "已登录",
              });
            }
          });

          return {
            form,
            rules,
            formRef,
            handleLogin,
            isLogin,
            quitClient,
            isStartWork,
            handleDuty,
            showInfo,
            operatorInfo,
            handleOperatorInfo,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
